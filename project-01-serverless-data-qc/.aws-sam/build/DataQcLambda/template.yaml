AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Serverless Data QC Pipeline (S3 -> Lambda -> reports/ prefix)

Parameters:
  InputBucketName:
    Type: String
    Description: "Name of the S3 bucket to receive CSVs (existing or to be created outside this template)"

Globals:
  Function:
    Runtime: python3.10
    Timeout: 30
    MemorySize: 256

Resources:

  DataQcLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub data-qc-lambda-${AWS::StackName}
      Handler: src.handler.handler
      Runtime: python3.10
      Timeout: 30
      MemorySize: 256
      Environment:
        Variables:
          BUCKET_NAME: !Ref InputBucketName
      Policies:
        - AWSLambdaBasicExecutionRole            # ensures CloudWatch Logs permissions
        - Version: "2012-10-17"                  # inline policy block to scope S3 access
          Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:PutObject
                - s3:ListBucket
              Resource:
                - !Sub arn:aws:s3:::${InputBucketName}
                - !Sub arn:aws:s3:::${InputBucketName}/*

      Events:
        CsvUpload:
          Type: S3
          Properties:
            Bucket: !Ref InputBucketName
            Events: s3:ObjectCreated:Put

Outputs:
  DataQcLambdaArn:
    Description: "ARN of the Data QC Lambda"
    Value: !GetAtt DataQcLambda.Arn
  InputBucketNameOut:
    Description: "Input bucket name"
    Value: !Ref InputBucketName
